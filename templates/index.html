<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Weather Brain – Carl’s Weather PA</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="page">
    <div class="header">
        <h1>Weather Brain</h1>
        <p>Your smart weather PA for boating, fishing and camping.</p>
    </div>

    <div class="layout">
        <!-- LEFT: Spot forecast -->
        <div class="card">
            <h2>Spot forecast</h2>
            <div class="card-body">
                <div class="form-row">
                    <label for="spot-select">Location</label>
                    <select id="spot-select">
                        {% for sid, spot in spots.items() %}
                        <option value="{{ sid }}">{{ spot.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-row">
                    <label for="days-input">Days ahead</label>
                    <input id="days-input" type="number" min="1" max="7" value="3">
                </div>

                <div class="form-row">
                    <label for="tone-select">Tone</label>
                    <select id="tone-select">
                        <option value="calm" selected>Calm</option>
                        <option value="blunt">Blunt</option>
                        <option value="optimistic">Optimistic</option>
                        <option value="cautious">Cautious</option>
                    </select>
                </div>

                <div class="form-row">
                    <label for="detail-select">Detail level</label>
                    <select id="detail-select">
                        <option value="short">Short</option>
                        <option value="normal" selected>Normal</option>
                        <option value="nerdy">Nerdy</option>
                    </select>
                </div>

                <div class="form-row">
                    <label class="checkbox-label">
                        <input id="wind-sensitive" type="checkbox" checked>
                        Wind-sensitive (be brutally honest about wind)
                    </label>
                </div>

                <button id="run-forecast">Get forecast</button>
                <div id="forecast-status" class="status small"></div>

                <!-- Forecast output now lives INSIDE the left card -->
                <hr>
                <div id="forecast-output" class="forecast-output small">
                    Pick a spot and hit "Get forecast".
                </div>
            </div>
        </div>

        <!-- RIGHT: Mission planner (+ caravan) -->
        <div class="card">
            <h2>Mission planner</h2>
            <div class="card-body">
                <p class="small">
                    Checks Te Anau / Moana, Hunter River via Lake Hawea, and Waikaia – then tells you
                    what’s actually worth doing over the next 10 days.
                </p>

                <button id="run-briefing">Run daily briefing</button>
                <div id="brief-status" class="status small"></div>

                <div id="brief-summary" class="summary-block small"></div>

                <div class="details-grid">
                    <div class="detail-card">
                        <h3>Te Anau / Moana</h3>
                        <div id="teanau-badge" class="badge"></div>
                        <div id="teanau-text" class="small"></div>
                    </div>
                    <div class="detail-card">
                        <h3>Hunter River</h3>
                        <div id="hunter-badge" class="badge"></div>
                        <div id="hunter-text" class="small"></div>
                    </div>
                    <div class="detail-card">
                        <h3>Waikaia</h3>
                        <div id="waikaia-badge" class="badge"></div>
                        <div id="waikaia-text" class="small"></div>
                    </div>
                </div>

                <hr>

                <!-- Caravan Mode lives INSIDE the mission planner card -->
                <section id="caravan-card">
                    <h3>Caravan Mode</h3>
                    <p class="small" id="caravan-description">
                        <!-- Filled by JS so it always matches the query params -->
                    </p>
                    <button id="caravan-check-btn" type="button">
                        Check caravan windows
                    </button>
                    <div id="caravan-output" class="small" style="margin-top: 0.75rem;">
                        No caravan scan yet.
                    </div>
                </section>
            </div>
        </div>
    </div>
</div>

<script>
    // ---------- Shared helpers ----------

    function verdictBadgeClass(v) {
        switch (v) {
            case "go": return "badge badge-go";
            case "maybe-go": return "badge badge-maybe";
            case "hold": return "badge badge-hold";
            default: return "badge badge-nowindow";
        }
    }

    // "2025-12-03" -> "Wed 3 Dec"
    function fmtDate(d) {
        const dt = new Date(d);
        const weekday = dt.toLocaleDateString("en-NZ", { weekday: "short" });
        const day = dt.getDate();
        const month = dt.toLocaleDateString("en-NZ", { month: "short" });
        return `${weekday} ${day} ${month}`;
    }

    // Turn "(2025-12-03 → 2025-12-04)" into "(Wed 3 Dec → Thu 4 Dec)" and bold it
    function prettyWindowText(text) {
        if (!text) return "";

        // Ranges like "(2025-12-03 → 2025-12-04)"
        text = text.replace(
            /\((\d{4}-\d{2}-\d{2})\s*[→\-–—>]\s*(\d{4}-\d{2}-\d{2})\)/g,
            (match, start, end) => {
                const startPretty = fmtDate(start);
                const endPretty = fmtDate(end);
                return `(<strong>${startPretty} → ${endPretty}</strong>)`;
            }
        );

        // Single dates like "(2025-12-09)"
        text = text.replace(
            /\((\d{4}-\d{2}-\d{2})\)/g,
            (match, singleDate) => {
                const pretty = fmtDate(singleDate);
                return `(<strong>${pretty}</strong>)`;
            }
        );

        return text;
    }

    // ---------- Spot forecast ----------

    async function runForecast() {
        const spotId = document.getElementById("spot-select").value;
        const days = parseInt(document.getElementById("days-input").value || "3", 10);
        const tone = document.getElementById("tone-select").value;
        const detail = document.getElementById("detail-select").value;
        const windSensitive = document.getElementById("wind-sensitive").checked;

        const statusEl = document.getElementById("forecast-status");
        const outputEl = document.getElementById("forecast-output");

        statusEl.textContent = "Fetching forecast…";
        outputEl.textContent = "";

        try {
            const resp = await fetch("/api/forecast", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    spot_id: spotId,
                    days: days,
                    tone: tone,
                    detail_level: detail,
                    wind_sensitive: windSensitive
                })
            });

            if (!resp.ok) {
                const txt = await resp.text();
                statusEl.textContent = "Error: " + txt;
                return;
            }

            const data = await resp.json();
            statusEl.textContent = `Forecast for ${data.spot_name} (${data.days} day(s))`;

            const raw = data.narrative || "No narrative returned.";

            // Bold the day/date part at the start of each paragraph.
            // Handles:
            //   - "Sunday (Nov 30)"
            //   - "Sunday, 30 November"
            //   - "Sunday 30 November"
            //   - "Sunday, November 30"
            //   - "Sunday November 30"
            //   - plain "Friday" / "Saturday" on their own line
            outputEl.innerHTML = raw
                // New style: "Sunday (Nov 30)"
                .replace(
                    /^([A-Za-z]+(?:\s*\([A-Za-z]{3}\s+\d{1,2}\)))/gm,
                    '<strong class="day-head">$1</strong>'
                )
                // Older styles with explicit date text
                .replace(
                    /^([A-Za-z]+,?\s+(?:\d{1,2}\s+[A-Za-z]+|[A-Za-z]+\s+\d{1,2}))/gm,
                    '<strong class="day-head">$1</strong>'
                )
                // Plain weekday headings like "Friday" on their own line
                .replace(
                    /^([A-Za-z]+)\s*$/gm,
                    '<strong class="day-head">$1</strong>'
                );

        } catch (err) {
            statusEl.textContent = "Error talking to backend.";
            console.error(err);
        }
    }

    // ---------- Daily briefing (mission planner cards) ----------

    async function runBriefing() {
        const statusEl = document.getElementById("brief-status");
        const summaryEl = document.getElementById("brief-summary");

        const teBadge = document.getElementById("teanau-badge");
        const teText = document.getElementById("teanau-text");
        const huBadge = document.getElementById("hunter-badge");
        const huText = document.getElementById("hunter-text");
        const waBadge = document.getElementById("waikaia-badge");
        const waText = document.getElementById("waikaia-text");

        statusEl.textContent = "Running planner…";
        summaryEl.textContent = "";
        teBadge.textContent = huBadge.textContent = waBadge.textContent = "";
        teText.textContent = huText.textContent = waText.textContent = "";

        try {
            const resp = await fetch("/api/daily_briefing?days=10");
            if (!resp.ok) {
                const txt = await resp.text();
                statusEl.textContent = "Error: " + txt;
                return;
            }

            const data = await resp.json();
            statusEl.textContent = "";

            // Prettify any window or dates in the summary text
            const summaryRaw = data.summary || "";
            summaryEl.innerHTML = prettyWindowText(summaryRaw);

            const te = data.teanau || {};
            const hu = data.hunter || {};
            const wa = data.waikaia || {};

            const teVerdict = te.verdict || "no-window";
            teBadge.className = verdictBadgeClass(teVerdict);
            teBadge.textContent = teVerdict.toUpperCase();
            teText.innerHTML = prettyWindowText(te.reason || "");

            const huVerdict = hu.verdict || "no-window";
            huBadge.className = verdictBadgeClass(huVerdict);
            huBadge.textContent = huVerdict.toUpperCase();
            huText.innerHTML = prettyWindowText(hu.reason || "");

            const waVerdict = wa.verdict || "no-window";
            waBadge.className = verdictBadgeClass(waVerdict);
            waBadge.textContent = waVerdict.toUpperCase();
            waText.innerHTML = prettyWindowText(wa.reason || "");

        } catch (err) {
            statusEl.textContent = "Error talking to backend.";
            console.error(err);
        }
    }

    // ---------- Caravan Mode (uses /api/caravan) ----------

    const CARAVAN_DAYS = 7;
    const CARAVAN_MIN_NIGHTS = 2;

    async function fetchCaravanWindows() {
        const output = document.getElementById("caravan-output");
        output.textContent = "Checking caravan windows…";

        try {
            const res = await fetch(`/api/caravan?days=${CARAVAN_DAYS}&min_nights=${CARAVAN_MIN_NIGHTS}`);
            if (!res.ok) {
                output.textContent = `Error from server: ${res.status}`;
                return;
            }

            const data = await res.json();
            const windows = data.windows || [];

            if (!windows.length) {
                output.textContent =
                    "No decent caravan windows in the next few days. Stay home, tie flies.";
                return;
            }

            // Take the best window (first in the sorted list)
            const w = windows[0];

            const startPretty = fmtDate(w.start_date);
            const endPretty = fmtDate(w.end_date);
            const nights = w.nights;

            const titleLine =
                `<strong>${w.region_name}</strong> – ` +
                `${nights} night${nights === 1 ? "" : "s"} look mint ` +
                `(<strong>${startPretty} → ${endPretty}</strong>)`;

            const campBits = new Set();
            const groundBits = new Set();
            const towBits = new Set();

            (w.days || []).forEach(d => {
                (d.notes || []).forEach(n => {
                    if (n.startsWith("Camp:")) {
                        campBits.add(n.replace("Camp:", "").trim());
                    } else if (n.startsWith("Ground:")) {
                        groundBits.add(n.replace("Ground:", "").trim());
                    } else if (n.startsWith("Towing:") || n.startsWith("Gusts:")) {
                        towBits.add(n.trim());
                    }
                });
            });

            const campText = campBits.size
                ? Array.from(campBits).join(", ")
                : "Conditions at camp look fine.";

            const groundText = groundBits.size
                ? Array.from(groundBits).join(", ")
                : "";

            const towText = towBits.size
                ? Array.from(towBits).join(" / ")
                : "Towing looks easy the whole route.";

            const lines = [];
            lines.push(titleLine);
            lines.push(`<strong>Camp:</strong> ${campText}`);
            if (groundText) {
                lines.push(`<strong>Ground:</strong> ${groundText}`);
            }
            lines.push(`<strong>Travel:</strong> ${towText}`);

            output.innerHTML = lines.join("<br>");
        } catch (err) {
            console.error(err);
            output.textContent = "Could not talk to the caravan engine. Is the server running?";
        }
    }

    // ---------- Wire up buttons & caravan description ----------

    document.addEventListener("DOMContentLoaded", () => {
        const btnForecast = document.getElementById("run-forecast");
        if (btnForecast) {
            btnForecast.addEventListener("click", runForecast);
        }

        const btnBrief = document.getElementById("run-briefing");
        if (btnBrief) {
            btnBrief.addEventListener("click", runBriefing);
        }

        const btnCaravan = document.getElementById("caravan-check-btn");
        if (btnCaravan) {
            btnCaravan.addEventListener("click", fetchCaravanWindows);
        }

        const caravanDesc = document.getElementById("caravan-description");
        if (caravanDesc) {
            caravanDesc.textContent =
                `Scans the next ${CARAVAN_DAYS} days for ` +
                `${CARAVAN_MIN_NIGHTS}+ night caravan windows ` +
                `within your predefined regions.`;
        }
    });
</script>
</body>
</html>