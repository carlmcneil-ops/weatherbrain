<!DOCTYPE html>
<html lang="en">
<head>
   <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Weather Brain – Carl’s Weather PA</title>
    <link rel="stylesheet" href="/static/style.css">
    ...

    <!-- Modal styles only (do not touch existing layout / buttons) -->
    <style>
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.65);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .modal-card {
        background: #0b1015;
        border-radius: 12px;
        border: 1px solid #3a4252;
        max-width: 720px;
        width: 90%;
        max-height: 80vh;
        padding: 16px 20px;
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.6);
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 8px;
      }

      .modal-header h2 {
        margin: 0;
        font-size: 18px;
      }

      .modal-close {
        border: none;
        background: transparent;
        color: #b0b7c5;
        font-size: 20px;
        cursor: pointer;
      }

      .modal-close:hover {
        color: #ffffff;
      }

      .modal-body p {
        font-size: 14px;
        line-height: 1.5;
        color: #d0d4de;
      }

      .modal-body h3 {
        margin-top: 14px;
        margin-bottom: 6px;
        font-size: 15px;
        font-weight: 600;
      }

      .modal-body ul {
        margin: 6px 0 10px 18px;
        padding: 0;
        font-size: 14px;
        color: #d0d4de;
      }

      .modal-body li {
        margin-bottom: 4px;
      }

      .hidden {
        display: none;
      }
    </style>
</head>
<body>
    <div class="page">
    <div class="header">
      <h1>Weather Brain</h1>
      <p>Your smart weather PA for boating, fishing and camping.</p>

      <div class="nav-chips">
  <button id="about-btn" class="chip">ABOUT WEATHER BRAIN</button>
  <a href="/admin" class="chip">SCORING ADMIN</a>
</div>
    </div>

    <div class="layout">
        <!-- LEFT: Spot forecast -->
        <div class="card">
            <h2>Spot forecast</h2>
            <div class="card-body">
                <div class="form-row">
                    <label for="spot-select">Location</label>
                    <select id="spot-select">
                        {% for sid, spot in spots.items() %}
                        <option value="{{ sid }}">{{ spot.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-row">
                    <label for="days-input">Days ahead</label>
                    <input id="days-input" type="number" min="1" max="7" value="3">
                </div>

                <div class="form-row">
                    <label for="tone-select">Tone</label>
                    <select id="tone-select">
                        <option value="calm" selected>Calm</option>
                        <option value="blunt">Blunt</option>
                        <option value="optimistic">Optimistic</option>
                        <option value="cautious">Cautious</option>
                    </select>
                </div>

                <div class="form-row">
                    <label for="detail-select">Detail level</label>
                    <select id="detail-select">
                        <option value="short">Short</option>
                        <option value="normal" selected>Normal</option>
                        <option value="nerdy">Nerdy</option>
                    </select>
                </div>

                <div class="form-row">
                    <label class="checkbox-label">
                        <input id="wind-sensitive" type="checkbox" checked>
                        Wind-sensitive (be brutally honest about wind)
                    </label>
                </div>

                <button id="run-forecast">Get forecast</button>
                <div id="forecast-status" class="status small"></div>

                <hr>
                <div id="forecast-output" class="forecast-output small">
                    Pick a spot and hit "Get forecast".
                </div>
            </div>
        </div>

        <!-- RIGHT: Mission planner (+ caravan) -->
        <div class="card">
            <h2>Mission planner</h2>
            <div class="card-body">
                <p class="small">
                    Checks Te Anau / Moana, Hunter River via Lake Hawea, and Waikaia – then tells you
                    what’s actually worth doing over the next 10 days.
                </p>

                <button id="run-briefing">Run daily briefing</button>
                <div id="brief-status" class="status small"></div>

                <div id="brief-summary" class="summary-block small"></div>

                <div class="details-grid">
                    <div class="detail-card">
                        <h3>Te Anau / Moana</h3>
                        <div id="teanau-badge" class="badge"></div>
                        <div id="teanau-text" class="small"></div>
                    </div>
                    <div class="detail-card">
                        <h3>Hunter River</h3>
                        <div id="hunter-badge" class="badge"></div>
                        <div id="hunter-text" class="small"></div>
                    </div>
                    <div class="detail-card">
                        <h3>Waikaia</h3>
                        <div id="waikaia-badge" class="badge"></div>
                        <div id="waikaia-text" class="small"></div>
                    </div>
                </div>

                <hr>

                <!-- Caravan Mode -->
                <section id="caravan-card">
                    <h3>Caravan Mode</h3>
                    <p class="small" id="caravan-description"></p>
                    <button id="caravan-check-btn" type="button">
                        Check caravan windows
                    </button>
                    <div id="caravan-output" class="small" style="margin-top: 0.75rem;">
                        No caravan scan yet.
                    </div>
                </section>
            </div>
        </div>
    </div>

  </div>

<script>
    // ---------- Shared helpers ----------

    function verdictBadgeClass(v) {
        switch (v) {
            case "go": return "badge badge-go";
            case "maybe-go": return "badge badge-maybe";
            case "hold": return "badge badge-hold";
            default: return "badge badge-nowindow";
        }
    }

    // "2025-12-03" -> "Wed 3 Dec"
    function fmtDate(d) {
        const dt = new Date(d);
        const weekday = dt.toLocaleDateString("en-NZ", { weekday: "short" });
        const day = dt.getDate();
        const month = dt.toLocaleDateString("en-NZ", { month: "short" });
        return `${weekday} ${day} ${month}`;
    }

    // Turn "(2025-12-03 → 2025-12-04)" into "(Wed 3 Dec → Thu 4 Dec)" and bold it
    function prettyWindowText(text) {
        if (!text) return "";

        // Ranges like "(2025-12-03 → 2025-12-04)"
        text = text.replace(
            /\((\d{4}-\d{2}-\d{2})\s*[→\-–—>]\s*(\d{4}-\d{2}-\d{2})\)/g,
            (match, start, end) => {
                const startPretty = fmtDate(start);
                const endPretty = fmtDate(end);
                return `(<strong>${startPretty} → ${endPretty}</strong>)`;
            }
        );

        // Single dates like "(2025-12-09)"
        text = text.replace(
            /\((\d{4}-\d{2}-\d{2})\)/g,
            (match, singleDate) => {
                const pretty = fmtDate(singleDate);
                return `(<strong>${pretty}</strong>)`;
            }
        );

        return text;
    }

    // ---------- Forecast formatting (day blocks, tidy spacing) ----------

    function formatForecastNarrative(raw) {
        if (!raw) return "";

        const lines = raw.split(/\r?\n/);
        const blocks = [];
        let current = null;
        let skippedTitle = false;

        // Matches: "Tuesday, December 2nd" / "Wednesday, December 3rd" etc
        const headingRegex =
            /^([A-Za-z]+,\s+[A-Za-z]+\s+\d{1,2}(?:st|nd|rd|th)?)\b(.*)$/;

        for (const rawLine of lines) {
            const line = rawLine.trim();
            if (!line) continue;

            // Markdown headings like **Lake Wanaka – Paddock Bay Fishing Forecast**
            const mdMatch = line.match(/^\*\*(.+?)\*\*$/);
            if (mdMatch) {
                if (!skippedTitle) {
                    // First markdown heading is the overall title – skip it.
                    skippedTitle = true;
                } else {
                    // If the model ever gives **December 2nd** style headings,
                    // treat them as a new day block.
                    const headingText = mdMatch[1].trim();
                    current = { heading: headingText, chunks: [] };
                    blocks.push(current);
                }
                continue;
            }

            const h = line.match(headingRegex);
            if (h) {
                const headingText = h[1].trim();
                let rest = (h[2] || "").trim();
                rest = rest.replace(/^[\s,\-–—:]+/, "").trim();

                current = { heading: headingText, chunks: [] };
                blocks.push(current);

                if (rest) {
                    current.chunks.push(rest);
                }
            } else if (current) {
                // Normal text line belonging to the current day
                current.chunks.push(line);
            } else {
                // Text before any heading – treat as a plain paragraph
                if (!blocks.length || blocks[blocks.length - 1].heading) {
                    blocks.push({ heading: null, chunks: [line] });
                } else {
                    blocks[blocks.length - 1].chunks.push(line);
                }
            }
        }

        const out = [];

        for (const b of blocks) {
            const text = b.chunks.join(" ");  // glue into one paragraph

            if (b.heading) {
                out.push(
                    `<div class="day-block">` +
                    `<div class="day-head">${b.heading}</div>` +
                    `<p>${text}</p>` +
                    `</div>`
                );
            } else {
                out.push(`<p>${text}</p>`);
            }
        }

        return out.join("\n\n");
    }

    // ---------- Spot forecast ----------

    async function runForecast() {
        const spotId = document.getElementById("spot-select").value;
        const days = parseInt(document.getElementById("days-input").value || "3", 10);
        const tone = document.getElementById("tone-select").value;
        const detail = document.getElementById("detail-select").value;
        const windSensitive = document.getElementById("wind-sensitive").checked;

        const statusEl = document.getElementById("forecast-status");
        const outputEl = document.getElementById("forecast-output");

        statusEl.textContent = "Fetching forecast…";
        outputEl.textContent = "";

        try {
            const resp = await fetch("/api/forecast", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    spot_id: spotId,
                    days: days,
                    tone: tone,
                    detail_level: detail,
                    wind_sensitive: windSensitive
                })
            });

            if (!resp.ok) {
                const txt = await resp.text();
                statusEl.textContent = "Error: " + txt;
                return;
            }

            const data = await resp.json();
            statusEl.textContent = `Forecast for ${data.spot_name} (${data.days} day(s))`;

            const raw = data.narrative || "No narrative returned.";
            const formatted = formatForecastNarrative(raw);
            outputEl.innerHTML = formatted;

        } catch (err) {
            statusEl.textContent = "Error talking to backend.";
            console.error(err);
        }
    }

    // ---------- Daily briefing ----------

    async function runBriefing() {
        const statusEl = document.getElementById("brief-status");
        const summaryEl = document.getElementById("brief-summary");

        const teBadge = document.getElementById("teanau-badge");
        const teText = document.getElementById("teanau-text");
        const huBadge = document.getElementById("hunter-badge");
        const huText = document.getElementById("hunter-text");
        const waBadge = document.getElementById("waikaia-badge");
        const waText = document.getElementById("waikaia-text");

        statusEl.textContent = "Scanning Te Anau, Hunter and Waikaia profiles for windows…";
        summaryEl.textContent = "";
        teBadge.textContent = huBadge.textContent = waBadge.textContent = "";
        teText.textContent = huText.textContent = waText.textContent = "";

        try {
            const resp = await fetch("/api/daily_briefing?days=10");
            if (!resp.ok) {
                const txt = await resp.text();
                statusEl.textContent = "Error: " + txt;
                return;
            }

            const data = await resp.json();
            statusEl.textContent = "";

            const summaryRaw = data.summary || "";
            summaryEl.innerHTML = prettyWindowText(summaryRaw);

            const te = data.teanau || {};
            const hu = data.hunter || {};
            const wa = data.waikaia || {};

            const teVerdict = te.verdict || "no-window";
            teBadge.className = verdictBadgeClass(teVerdict);
            teBadge.textContent = teVerdict.toUpperCase();
            teText.innerHTML = prettyWindowText(te.reason || "");

            const huVerdict = hu.verdict || "no-window";
            huBadge.className = verdictBadgeClass(huVerdict);
            huBadge.textContent = huVerdict.toUpperCase();
            huText.innerHTML = prettyWindowText(hu.reason || "");

            const waVerdict = wa.verdict || "no-window";
            waBadge.className = verdictBadgeClass(waVerdict);
            waBadge.textContent = waVerdict.toUpperCase();
            waText.innerHTML = prettyWindowText(wa.reason || "");

        } catch (err) {
            statusEl.textContent = "Error talking to backend.";
            console.error(err);
        }
    }

    // ---------- Metvuw situation map ----------

    function loadMetvuwMap() {
        const img = document.getElementById("metvuw-map");
        const status = document.getElementById("map-status");
        if (!img) return;

        if (status) status.textContent = "Loading map…";

        // South Island rain chart, 6h step, cache-busted
        const baseUrl = "https://www.metvuw.com/forecast/forecast1.php?type=rain&region=nzsi&tim=006";
        const url = baseUrl + "&_=" + Date.now();

        img.onload = () => {
            if (status) status.textContent = "";
        };

        img.onerror = () => {
            if (status) status.textContent = "Couldn’t load Metvuw map.";
        };

        img.src = url;
    }

    // ---------- Caravan Mode (top 2 windows) ----------

    async function wbRunCaravanScan() {
      const btn = document.getElementById("caravan-check-btn");
      const out = document.getElementById("caravan-output");
      const desc = document.getElementById("caravan-description");

      if (!btn || !out) {
        console.error("Caravan elements not found");
        return;
      }

      btn.disabled = true;
      out.innerHTML = "Checking caravan windows…";

      try {
        const res = await fetch("/api/caravan?days=7");
        if (!res.ok) {
          throw new Error("Bad response from /api/caravan");
        }
        const data = await res.json();

        const daysConsidered = data.days_considered || 7;
        const minNights = data.min_nights || 2;

        if (desc) {
          desc.textContent = `Scans the next ${daysConsidered} days for ${minNights}+ night caravan windows within your predefined regions.`;
        }

        const allWindows = Array.isArray(data.windows) ? data.windows : [];
        if (!allWindows.length) {
          out.innerHTML = `<p>No ${minNights}+ night caravan windows in the next ${daysConsidered} days.</p>`;
          return;
        }

        // Take the best two by avg_score
        const windows = allWindows
          .slice()
          .sort((a, b) => (b.avg_score || 0) - (a.avg_score || 0))
          .slice(0, 2);

        const html = windows
          .map((w, idx) => {
            const title = `${w.region_name} – ${w.nights} night${w.nights > 1 ? "s" : ""} `
              + `(${fmtDate(w.start_date)} → ${fmtDate(w.end_date)})`;

            const allNotes = (w.days || []).flatMap(d => d.notes || []);

            const campNotes   = allNotes.filter(n => n.startsWith("Camp:"));
            const groundNotes = allNotes.filter(n => n.startsWith("Ground:"));
            const towNotes    = allNotes.filter(n => n.startsWith("Towing:"));
            const gustNotes   = allNotes.filter(n => n.startsWith("Gusts:"));

            const mergeNotes = (list, label) => {
              if (!list.length) return "";
              const stripped = list.map(n => n.replace(label + ":", "").trim());
              const uniq = [...new Set(stripped)];
              return uniq.join(", ");
            };

            const campText   = mergeNotes(campNotes, "Camp")   || "OK";
            const groundText = mergeNotes(groundNotes, "Ground") || "OK";
            const towText    = mergeNotes(towNotes, "Towing")  || "OK";
            const gustText   = mergeNotes(gustNotes, "Gusts")  || "OK";

            const label = idx === 0 ? "BEST OPTION" : "ALSO GOOD";

            return `
              <div class="detail-card" style="margin-top:0.75rem;">
                <h4 style="margin-bottom:0.25rem;">
                  <span class="pill pill-go" style="margin-right:0.4rem;">${label}</span>
                  ${title}
                </h4>
                <p><strong>Camp:</strong> ${campText}</p>
                <p><strong>Ground:</strong> ${groundText}</p>
                <p><strong>Travel:</strong> Towing: ${towText} / Gusts: ${gustText}</p>
              </div>
            `;
          })
          .join("");

        out.innerHTML = html;
      } catch (err) {
        console.error(err);
        out.innerHTML = "<p>Couldn’t fetch caravan windows right now.</p>";
      } finally {
        btn.disabled = false;
      }
    }

    // ---------- Wire up ----------

    document.addEventListener("DOMContentLoaded", () => {
        const btnForecast = document.getElementById("run-forecast");
        if (btnForecast) btnForecast.addEventListener("click", runForecast);

        const btnBrief = document.getElementById("run-briefing");
        if (btnBrief) btnBrief.addEventListener("click", runBriefing);

        const btnCaravan = document.getElementById("caravan-check-btn");
        if (btnCaravan) btnCaravan.addEventListener("click", wbRunCaravanScan);

        const caravanDesc = document.getElementById("caravan-description");
        if (caravanDesc && !caravanDesc.textContent.trim()) {
            caravanDesc.textContent =
                "Scans the next 7 days for 2+ night caravan windows within your predefined regions.";
        }

        const mapBtn = document.getElementById("refresh-map-btn");
        if (mapBtn) {
            mapBtn.addEventListener("click", (e) => {
                e.preventDefault();
                loadMetvuwMap();
            });
        }

        // Load map on page open
        loadMetvuwMap();
    });
</script>

<!-- About modal -->
<div id="about-modal" class="modal-backdrop hidden">
  <div class="modal-card">
    <div class="modal-header">
      <h2>About Weather Brain</h2>
      <button class="modal-close" id="about-close" aria-label="Close">×</button>
    </div>
    <div class="modal-body">
      <p>
        Weather Brain is your weather-obsessed trip planner for boating, fishing and camping missions
        within striking distance of Wanaka.
      </p>

      <p>
        Instead of you staring at five different weather apps, it pulls forecast data from Open-Meteo
        and runs your own custom scoring logic over the next few days. It then tells you where the
        best “mission windows” are – or if you’re better off staying home.
      </p>

      <h3>What it actually checks</h3>
      <ul>
        <li><strong>Wind &amp; gusts:</strong> how hard it’ll blow in the places you care about, and what it feels like for small boats and towing.</li>
        <li><strong>Rain &amp; recent soak:</strong> today’s rain plus the last 48 hours to estimate how soggy campsites and tracks will be.</li>
        <li><strong>Boating comfort:</strong> combines wind, gusts and rain into a simple score for fizz boats on Lake Hāwea and Moana missions on Lake Te Anau.</li>
        <li><strong>Camping &amp; river fishing:</strong> looks at wind and rain to decide whether Waikaia / Piano Flat is worth the drive and tent faff.</li>
        <li><strong>Caravan missions:</strong> scans broad regions within ~4 hours of Wanaka (Benmore/Mackenzie, Haast, Catlins, etc.) for multi-night windows that are safe to tow and comfortable to camp.</li>
      </ul>

      <h3>How the scoring works</h3>
      <p>
        Each mission type (Hunter fizz boat, Moana on Te Anau, Waikaia camping, Caravan Mode) has its own set
        of thresholds – minimum window length, and GO / MAYBE cut-offs. Weather Brain scores each day on a 0–100
        scale, finds consecutive runs that meet your minimum length, and then grades them:
      </p>

      <ul>
        <li><strong>GO:</strong> solid window worth planning for.</li>
        <li><strong>MAYBE:</strong> borderline but might be fine if you’re flexible.</li>
        <li><strong>HOLD / NO-WINDOW:</strong> conditions or duration don’t stack up.</li>
      </ul>

      <p>
        Those thresholds live in the <strong>Scoring admin</strong> panel so you can tune how picky it is
        without touching any code.
      </p>

      <p>
        Bottom line: Weather Brain doesn’t replace your judgement – it just chews through the data so you can
        spend less time doom-scrolling forecasts and more time actually out there.
      </p>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const aboutBtn = document.getElementById("about-btn");
    const aboutModal = document.getElementById("about-modal");
    const aboutClose = document.getElementById("about-close");

    if (aboutBtn && aboutModal) {
      aboutBtn.addEventListener("click", () => {
        aboutModal.classList.remove("hidden");
      });
    }

    if (aboutClose && aboutModal) {
      aboutClose.addEventListener("click", () => {
        aboutModal.classList.add("hidden");
      });
    }

    // Close when clicking outside the card
    if (aboutModal) {
      aboutModal.addEventListener("click", (e) => {
        if (e.target === aboutModal) {
          aboutModal.classList.add("hidden");
        }
      });
    }
  });
</script>
</body>
</html>