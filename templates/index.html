<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Weather Brain – Carl’s Weather PA</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="page">
    <div class="header">
        <h1>Weather Brain</h1>
        <p>Your smart weather PA for boating, fishing and camping.</p>
    </div>

    <div class="layout">
        <!-- LEFT: Spot forecast -->
        <div class="card">
            <h2>Spot forecast</h2>
            <div class="card-body">
                <div class="form-row">
                    <label for="spot-select">Location</label>
                    <select id="spot-select">
                        {% for sid, spot in spots.items() %}
                        <option value="{{ sid }}">{{ spot.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-row">
                    <label for="days-input">Days ahead</label>
                    <input id="days-input" type="number" min="1" max="7" value="3">
                </div>

                <div class="form-row">
                    <label for="tone-select">Tone</label>
                    <select id="tone-select">
                        <option value="calm" selected>Calm</option>
                        <option value="blunt">Blunt</option>
                        <option value="optimistic">Optimistic</option>
                        <option value="cautious">Cautious</option>
                    </select>
                </div>

                <div class="form-row">
                    <label for="detail-select">Detail level</label>
                    <select id="detail-select">
                        <option value="short">Short</option>
                        <option value="normal" selected>Normal</option>
                        <option value="nerdy">Nerdy</option>
                    </select>
                </div>

                <div class="form-row">
                    <label class="checkbox-label">
                        <input id="wind-sensitive" type="checkbox" checked>
                        Wind-sensitive (be brutally honest about wind)
                    </label>
                </div>

                <button id="run-forecast">Get forecast</button>
                <div id="forecast-status" class="status small"></div>
            </div>
        </div>

        <!-- RIGHT: Mission planner -->
        <div class="card">
            <h2>Mission planner</h2>
            <div class="card-body">
                <p class="small">
                    Checks Te Anau / Moana, Hunter via Lake Hawea, and Waikaia – then tells you
                    what’s actually worth doing.
                </p>

                <button id="run-briefing">Run daily briefing</button>
                <div id="brief-status" class="status small"></div>

                <div id="brief-summary" class="summary-block small"></div>

                <div class="details-grid">
                    <div class="detail-card">
                        <h3>Te Anau / Moana</h3>
                        <div id="teanau-badge" class="badge"></div>
                        <div id="teanau-text" class="small"></div>
                    </div>
                    <div class="detail-card">
                        <h3>Hunter via Hawea</h3>
                        <div id="hunter-badge" class="badge"></div>
                        <div id="hunter-text" class="small"></div>
                    </div>
                    <div class="detail-card">
                        <h3>Waikaia – Piano Flat</h3>
                        <div id="waikaia-badge" class="badge"></div>
                        <div id="waikaia-text" class="small"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Forecast output card -->
    <div class="card" style="margin-top: 20px;">
        <h2>Forecast output</h2>
        <div class="card-body">
            <div id="forecast-output" class="forecast-output small">
                Pick a spot and hit "Get forecast", or run the daily briefing.
            </div>
        </div>
    </div>
</div>

<script>
    // Verdict → badge CSS class
    function verdictBadgeClass(v) {
        switch (v) {
            case "go":        return "badge badge-go";
            case "maybe-go":  return "badge badge-maybe";
            case "hold":      return "badge badge-hold";
            default:          return "badge badge-nowindow";
        }
    }

    // Turn "2025-12-03" into "Wed 3 Dec"
    function fmtDate(d) {
        const dt = new Date(d);
        const weekday = dt.toLocaleDateString("en-NZ", { weekday: "short" });
        const day = dt.getDate();
        const month = dt.toLocaleDateString("en-NZ", { month: "short" });
        return `${weekday} ${day} ${month}`;
    }

    // Prettify ISO dates in briefing text (summary + reason fields)
    function prettyWindowText(text) {
        if (!text) return "";

        let out = text;

        // 1) Date ranges with or without brackets:
        //    "2025-12-03 → 2025-12-04"
        //    "(2025-12-03 -> 2025-12-04)"
        out = out.replace(
            /(\(?)(\d{4}-\d{2}-\d{2})\s*[→\-–—>]\s*(\d{4}-\d{2}-\d{2})(\)?)/g,
            (match, open, start, end, close) => {
                return `${open}<strong>${fmtDate(start)} → ${fmtDate(end)}</strong>${close}`;
            }
        );

        // 2) Single dates with or without brackets:
        //    "2025-12-04" or "(2025-12-04)"
        out = out.replace(
            /(\(?)(\d{4}-\d{2}-\d{2})(\)?)/g,
            (match, open, date, close) => {
                return `${open}<strong>${fmtDate(date)}</strong>${close}`;
            }
        );

        return out;
    }

    // ---------- Spot forecast ----------

    async function runForecast() {
        const spotId       = document.getElementById("spot-select").value;
        const days         = parseInt(document.getElementById("days-input").value || "3", 10);
        const tone         = document.getElementById("tone-select").value;
        const detail       = document.getElementById("detail-select").value;
        const windSensitive = document.getElementById("wind-sensitive").checked;

        const statusEl = document.getElementById("forecast-status");
        const outputEl = document.getElementById("forecast-output");

        statusEl.textContent = "Fetching forecast…";
        outputEl.textContent = "";

        try {
            const resp = await fetch("/api/forecast", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    spot_id:       spotId,
                    days:          days,
                    tone:          tone,
                    detail_level:  detail,
                    wind_sensitive: windSensitive,
                }),
            });

            if (!resp.ok) {
                const txt = await resp.text();
                statusEl.textContent = "Error: " + txt;
                return;
            }

            const data = await resp.json();
            statusEl.textContent = `Forecast for ${data.spot_name} (${data.days} day(s))`;

            const raw = data.narrative || "No narrative returned.";

            // Bold the leading "Friday, 29 November" bit for each paragraph
            outputEl.innerHTML = raw.replace(
                /^([A-Za-z]+,\s+\d{1,2}\s+[A-Za-z]+)/gm,
                '<strong class="day-head">$1</strong>'
            );
        } catch (err) {
            statusEl.textContent = "Error talking to backend.";
            console.error(err);
        }
    }

    // ---------- Mission planner / daily briefing ----------

    async function runBriefing() {
        const statusEl  = document.getElementById("brief-status");
        const summaryEl = document.getElementById("brief-summary");

        const teBadge = document.getElementById("teanau-badge");
        const teText  = document.getElementById("teanau-text");
        const huBadge = document.getElementById("hunter-badge");
        const huText  = document.getElementById("hunter-text");
        const waBadge = document.getElementById("waikaia-badge");
        const waText  = document.getElementById("waikaia-text");

        statusEl.textContent = "Running planner…";
        summaryEl.textContent = "";
        teBadge.textContent = huBadge.textContent = waBadge.textContent = "";
        teText.textContent  = huText.textContent  = waText.textContent  = "";

        try {
            const resp = await fetch("/api/daily_briefing?days=10");
            if (!resp.ok) {
                const txt = await resp.text();
                statusEl.textContent = "Error: " + txt;
                return;
            }

            const data = await resp.json();
            statusEl.textContent = "";

            // Summary – allow bold + formatted dates
            const summaryRaw = data.summary || "";
            summaryEl.innerHTML = prettyWindowText(summaryRaw);

            const te = data.teanau  || {};
            const hu = data.hunter  || {};
            const wa = data.waikaia || {};

            // Te Anau / Moana card
            const teVerdict = te.verdict || "no-window";
            teBadge.className = verdictBadgeClass(teVerdict);
            teBadge.textContent = teVerdict.toUpperCase();
            teText.innerHTML = prettyWindowText(te.reason || "");

            // Hunter via Hawea card
            const huVerdict = hu.verdict || "no-window";
            huBadge.className = verdictBadgeClass(huVerdict);
            huBadge.textContent = huVerdict.toUpperCase();
            huText.innerHTML = prettyWindowText(hu.reason || "");

            // Waikaia card
            const waVerdict = wa.verdict || "no-window";
            waBadge.className = verdictBadgeClass(waVerdict);
            waBadge.textContent = waVerdict.toUpperCase();
            waText.innerHTML = prettyWindowText(wa.reason || "");
        } catch (err) {
            statusEl.textContent = "Error talking to backend.";
            console.error(err);
        }
    }

    // Wire up buttons
    document.getElementById("run-forecast").addEventListener("click", runForecast);
    document.getElementById("run-briefing").addEventListener("click", runBriefing);
</script>
</body>
</html>